---
title: 'The Effectiveness of Gender Quotas in Development Programming: Null Results from a Field Experiment in Congo'
author: "Peter van der Windt, Macartan Humphreys and Raul Sanchez de la Sierra"
date: "March 2018"
output:
  html_document:
    toc: true
    number_sections: yes
    theme: cerulean
    highlight: tango
  md_document:
    variant: markdown_github
---

```{r setup, include=FALSE}
rm(list=ls(all=TRUE)) 
gc()
knitr::opts_chunk$set(echo = TRUE)
```
[Data]: https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/BSASJR
["_The Effectiveness of Gender Quotas in Development Programming: Null Results from a Field Experiment in Congo_" from van der Windt, Humphreys, and Sanchez de la Sierra (2018)]: http://www.macartan.nyc/wp-content/uploads/2018/03/WHS2018_Gender_Parity.pdf
[This .Rmd]: https://github.com/medinali/VDW-H-SDS_2018/blob/master/Replication.Rmd
[replication code files] :https://github.com/medinali/VDW-H-SDS_2018


* [This .Rmd] file replicates the core analysis as well as additional results from ["_The Effectiveness of Gender Quotas in Development Programming: Null Results from a Field Experiment in Congo_" from van der Windt, Humphreys, and Sanchez de la Sierra (2018)].

* [Data] and [replication code files] can be found online. 


```{r, include = FALSE}
  
  # Replication Setup

  # Packages
  # Possibly necessary installations:
  # devtools::install_github("iqss/dataverse-client-r")
  # install.packages("rio")

  packages <- c("mfx", "AER", "foreign", "dplyr", "car", "nnet", "sandwich", "xtable", "knitr", "zoo", "dataverse", "triebeard", "rio", "base", "readstata13", "readr")
  invisible(lapply(packages, function(x) if (!require(x, character.only=T)){install.packages(x);library(x, character.only = T)}))
  
  # Helper functions
  source("R/0 helper mean_effects.R")
  source("R/0 helper cluster_robust.R")
  source("R/0 helper latex_functions.R")
  
```


```{r, echo=FALSE}
  
  # set options

  # save figure and tables to output folder
  saving <- TRUE
  output_folder <- "output"
  
  # random sample only (analyze only randomly sampled subjects, not chiefs or CDV reps)
  random_sample <- TRUE
  
  # projects list 1
  projects <- c("sante2", "education2", "transport2", "watsan2", "agr2")
  projects_labs <- c("Health", "Education", "Transport", "WatSan", "Agric.")
  
  # projects list 2
  RAPIDprojects <- c("RAPIDhealth", "RAPIDeducation", "RAPIDtransport", "RAPIDwatsan", "RAPIDagriculture", "RAPIDprivate")
  RAPID_projects_labs <- c("Health", "Education", "Transport", "WatSan", "Agric.", "Private")

  # preferred projects list
  pprojects <- c("health", "edu", "transport", "watsan", "agri", "private", "other")
  
  # attitudes list
  attitudes <- c("qg008_women2",  "qg009_mistreatment2", "qg010_socioadmin2", "qg011_women_pres2", "attitudes_mfi")
  attitudes_labs <- c("Same rights",  "Complain/mistreat", "Soc-Admin Pos", "Eligible Pres", "MFI")
```

```{r, echo=FALSE, warning=FALSE}
  #load data
  source("R/1 getdata.R")
```

```{r, echo=FALSE, warning=FALSE}
  #prepare data
  source("R/1 prep.R")
```

# Context information (Section 3)
Do people know the name of Congo's ruling party?
```{r, echo = TRUE, warning = FALSE}
  partyData <- merge(ABD_INDIV, Tuungane_data, by = "IDV")  
  partyData <- filter(partyData, TUUNGANE ==0 & q72_know_party!="")
  partyinfo1 <- 100*prop.table(table(partyData$q72_know_party))
  names(partyinfo1) <- c("No", "Yes, correct","Yes, incorrect")

  partyinfo2 <- 100*prop.table(table(partyData$q72_know_party, partyData$q011_sex)[,4:5],2)

  partyinfo <-cbind(partyinfo1,partyinfo2)    
    
  colnames(partyinfo) =  c("Combined", "Women", "Men")
  rownames(partyinfo) =  c("No", "Yes, correct", "Yes, incorrect")
  kable(partyinfo, digits = 2)
  
```

Do people know the name of Congo's prime minister?
```{r, echo = TRUE, warning = FALSE}

  pmData <- merge(ABD_INDIV, Tuungane_data, by = "IDV")  
  pmData <- filter(pmData, TUUNGANE ==0 & pmData$q70_know_pm!="")
  pm1 <- 100*prop.table(table(pmData$q70_know_pm,useNA ="no"))
  names(pm1) <- c("No", "Yes, correct","Yes, incorrect")

  pm2 <-100*prop.table(table(pmData$q70_know_pm, pmData$q011_sex)[,4:5],2)

  pm <-cbind(pm1,pm2)    

  colnames(pm) =  c("Combined", "Women", "Men")
  rownames(pm) =  c("No", "Yes, correct", "Yes, incorrect")
  kable(pm, digits = 2)

```

Who initiated development project (in percentages)?
```{r, echo = TRUE, warning = FALSE}
  na_answers <- c("don't know", "doesn't know", "not applicable","refuse to respond", "refuses to respond")
  whoData <- merge(ABD_INDIV, Tuungane_data, by = "IDV")  
  whoData <- filter(whoData, TUUNGANE ==0 & !q46_1h %in% na_answers)

  # Who initiates development projects
  table_who <- round(100*prop.table(table(whoData$q46_1h)),2)
  kable(data.frame(table_who[4:30]), col.names=c("Actor", "Share"))

```

```{r, warning = FALSE, echo = FALSE, include=FALSE}
source("R/Fig1_timeallocation.R")
```

## Time allocation on daily activities (Figure 1)
```{r, warning = FALSE, echo = TRUE, fig.height= 20, fig.width = 20}


#####################
## DRAW FIGURE
#####################

par(mfrow=c(2,1))
x <- seq(1,24,1)
yZERO <- rep(0,24)
yHUNDRED <- rep(100,24)

#####################
## FOR WOMEN
#####################

par(mar = c(2, 3, 4, 1)) # b, l, t, r

  plot(0,0, xlim=c(1,24), ylim=c(0,100), xlab="", ylab="", cex.lab=1.5, axes=F, frame.plot=F, type="n", main="Women", cex.main=1.5)
axis(1, at=seq(1,24,1), cex.axis=1)
axis(2, at=seq(0,100,20), cex.axis=1, label=c("0%", "20%", "40%", "60%", "80%", "100%"), las=1)

# draw polygons
  polygon(c(x,rev(x)),c(other[1,],rev(yHUNDRED)),col="white", border = "gray")
  polygon(c(x,rev(x)),c(org[1,],rev(yHUNDRED)),col="white", border = "gray")
  polygon(c(x,rev(x)),c(money[1,],rev(yHUNDRED)),col="white", border = "gray")
  polygon(c(x,rev(x)),c(sport[1,],rev(yHUNDRED)),col="white", border = "gray")
  polygon(c(x,rev(x)),c(edu[1,],rev(yHUNDRED)),col="white", border = "gray")
  polygon(c(x,rev(x)),c(personal[1,],rev(yHUNDRED)),col="white", border = "gray")
  polygon(c(x,rev(x)),c(domestic[1,],rev(yHUNDRED)),col="white", border = "gray")
  polygon(c(x,rev(x)),c(cleaning[1,],rev(yHUNDRED)),col="darkgray", border = "gray")
  polygon(c(x,rev(x)),c(water[1,],rev(yHUNDRED)),col="gray", border = "gray")
  polygon(c(x,rev(x)),c(cooking[1,],rev(yHUNDRED)),col="lightgray", border = "gray")
  polygon(c(x,rev(x)),c(sleep[1,],rev(yHUNDRED)),col="white", border = "gray")

# Add text
  text(9, 1, "Other", cex=1.2,adj = c(0,0))
  text(10, 5, "Social", cex=1.2,adj = c(0,0))
  text(8, 20, "Income-generating", cex=1.2,adj = c(0,0))
  text(16, 15, "Leisure", cex=1.2,adj = c(0,0))
  text(21.2, 12, "Education", cex=1.2,adj = c(0,0))
  lines(c(19,21),c(8,13), cex=2, lwd=1.2)
  text(16, 22, "Services", cex=1.2,adj = c(0,0))
  text(9.5, 50, "Field", cex=1.2,adj = c(0,0))
  text(8, 63, "Cleaning", cex=1.2,adj = c(0,0))
  text(8.5, 73, "Water", cex=1.2,adj = c(0,0))
  text(14, 45, "Cooking", cex=1.2,adj = c(0,0))
  text(16, 90, "Sleep and personal care", cex=1.2,adj = c(0,0))


#####################
## FOR MEN
#####################

  par(mar = c(2, 3, 4, 1)) # b, l, t, r

  plot(0,0, xlim=c(1,24), ylim=c(0,100), xlab="", ylab="", cex.lab=1.5, axes=F, frame.plot=F, type="n", main="Men", cex.main=1.5)
  axis(1, at=seq(1,24,1), cex.axis=1)
  axis(2, at=seq(0,100,20), cex.axis=1, label=c("0%", "20%", "40%", "60%", "80%", "100%"), las=1)

  # draw polygons
  polygon(c(x,rev(x)),c(other[2,],rev(yHUNDRED)),col="white", border = "gray")
  polygon(c(x,rev(x)),c(org[2,],rev(yHUNDRED)),col="white", border = "gray")
  polygon(c(x,rev(x)),c(money[2,],rev(yHUNDRED)),col="white", border = "gray")
  polygon(c(x,rev(x)),c(sport[2,],rev(yHUNDRED)),col="white", border = "gray")
  polygon(c(x,rev(x)),c(edu[2,],rev(yHUNDRED)),col="white", border = "gray")
  polygon(c(x,rev(x)),c(personal[2,],rev(yHUNDRED)),col="white", border = "gray")
  polygon(c(x,rev(x)),c(domestic[2,],rev(yHUNDRED)),col="white", border = "gray")
  polygon(c(x,rev(x)),c(cleaning[2,],rev(yHUNDRED)),col="darkgray", border = "gray")
  polygon(c(x,rev(x)),c(water[2,],rev(yHUNDRED)),col="gray", border = "gray")
  polygon(c(x,rev(x)),c(cooking[2,],rev(yHUNDRED)),col="lightgray", border = "gray")
  polygon(c(x,rev(x)),c(sleep[2,],rev(yHUNDRED)),col="white", border = "gray")

  # Add text
  text(9, 1, "Other", cex=1.2,adj = c(0,0))
  text(10, 7, "Social", cex=1.2,adj = c(0,0))
  text(8, 28, "Income-generating", cex=1.2,adj = c(0,0))
  text(16.5, 30, "Leisure", cex=1.2,adj = c(0,0))
  text(20.2, 38.1, "Education", cex=1.2,adj = c(0,0))
  lines(c(17.5,20),c(38.1,38.1), cex=2, lwd=1.2)
  text(16, 45, "Services", cex=1.2,adj = c(0,0))
  text(9.5, 70, "Field", cex=1.2,adj = c(0,0))
  text(19.2, 58, "Cleaning", cex=1.2,adj = c(0,0))
  lines(c(17,19),c(58,59), cex=2, lwd=1.2)
  text(16.2, 65, "Water", cex=1.2,adj = c(0,0))
  lines(c(16.5,16),c(59,66), cex=2, lwd=1.2)
  text(13.5, 54, "Cooking", cex=1.2,adj = c(0,0))
  text(16, 90, "Sleep and personal care", cex=1.2,adj = c(0,0))


 gender_plot <-  recordPlot()


```

```{r, warning = FALSE, echo = FALSE, fig.height= 20, fig.width = 20}

if(saving){ 
pdf(file=paste0(output_folder, "/Fig1_timeallocation.pdf"), width=10, height=12)
replayPlot(gender_plot)  
dev.off()
} 
```

## Project preferences by gender (Table 1) 
```{r, include=FALSE}

  prefsData <- merge(DMC, Tuungane_data, by = "IDV")  
  prefsData <- prefsData %>%
    filter(TUUNGANE ==0 & IDS_DISTRICT !="TG") %>%
    filter(lott_bin_name %in% c("13", "14", "ALUNGULI", "BAKONGOLA", "BAKUNDA", "BALOMOTWA", "BANWESHI", "BASANGA", "BUKAMA", "BUKANDA", "DIFUMA II", "IKOMA", "KABAMBARE", "KAFIRA", "KAMANYOLA", "KAMISIMBI", "KAMPENE", "KARHONGO", "KATAKOKOMBE", "KAYEMBE", "KAYUYU", "KIBANGULA", "KIBOMBO", "KIGOMA", "KIMYAKIMYA", "KINAMA", "KINKUNGWA", "KIONA NGOY", "KISAMAMBA", "KITAMBWE", "LEMERA", "LUCHIGA", "LURHALA", "LUSAMBA", "LUSANGI", "LUVUNGI", "LWAPULA", "MBINGA NORD", "MIKELENGE", "MUHUNGU", "RUNINGU", "SOURCE DU FLEUVE CONGO", "WAMAZA"))

  #if(local_data)  prefsData$female <- 1* (prefsData$av_10_gender == "female")
  #if(!local_data) prefsData$female <- 1* (prefsData$av_10_gender == 0)
  #prefsData$female <- 1* (prefsData$av_10_gender == 0)
  prefsData$female <- 1* (prefsData$av_10_gender == "female")
``` 

```{r, echo=TRUE}


prefs_table <- 
  sapply(pprojects, function(k) {
    output_function(lm_cluster_robust(paste(k, "~ female + as.factor(lott_bin)"), 
                                      data = prefsData, 
                                      cluster_name = "CDCCODE"), coefrows=2:3)})


## Control means in
means <-  apply(filter(prefsData, female==0)[, pprojects], 2, mean, na.rm=TRUE)
prefs_table <-rbind(prefs_table[1:2,], round(means,3), prefs_table[nrow(prefs_table),])
row.names(prefs_table) <- c("Parity Effect", "(se)", "Control", "N")
  
kable(prefs_table[,1:6])

# Are women's preferences in parity villages closer to men's preferences?
prefsData2 <- DMC
prefsData2$female <- 1* (prefsData2$av_10_gender == "female")

prefs_par_table <-
  sapply(pprojects, function(k) {
    # output_function(
    M <- lm_cluster_robust(paste(k, "~ female*cdc_parity + as.factor(lott_bin)"), data = prefsData2,
                                      cluster_name = "CDCCODE")#, coefrows=2:3)})
    coefs <- M[[1]][rownames(M[[1]]) %in% c("(Intercept)", "female","cdc_parity","female:cdc_parity"),]
    beta = round(coefs[,"Estimate"], 3)
    se = round(coefs[,"Std. Error"], 3)
    stars =  unlist(lapply(coefs[,"Pr(>|t|)"], function(p) ifelse(p <= .01, "***", ifelse(p <= .05, "**", ifelse(p <= .1, "*", "")))))
    return(rbind(paste0(beta, stars), paste0("(",se,")")))
    })

prefs_par_table <- cbind(c("male","", "female", "","cdc_parity", "", "female*cdc_parity",""), prefs_par_table)
```

```{r, echo = FALSE, include = FALSE}
T1 <- rbind(
  "\\begin{tabular}{lcccccc}",
  "	&	Health	&	Edu. 	    &	Transport	  	&	Watsan  &	Agric. & Private	 \\\\ \\hline \\hline",

  mat_to_tex(prefs_table[,-7], rownames = c("Difference for women", "(se)", "Men", "N")) ,
  "\\hline \\hline \\mc{7}{l}{\\parbox{5in}{\\small\\singlespace  
  \\textit{Notes:} Differences in preferences by gender. We report sample average treatment effects. Regressions use block fixed effects. Standard errors clustered at the village cluster level. Based on question AV14. $* p \\le 0.10, ** p \\le 0.05, *** p \\le  0.01$.}
  }",
  "\\label{tab:RAPIDpreferences}",
  "\\end{tabular}"
)

if(saving){
  sink(paste0(output_folder, "/Table1_rapidprefs.tex"))
tablr(T1)
sink()
}
```

## Share of project preferences, by gender (in text) 
```{r, echo=TRUE}

  abs_f <- colSums(prefsData[prefsData$female==1,pprojects], na.rm = TRUE)
  pct_pref_f <- round(abs_f/sum(abs_f), 3)
  
  abs_m <- colSums(prefsData[prefsData$female==0,pprojects], na.rm = TRUE)
  pct_pref_m <- round(abs_m/sum(abs_m), 3)

  kable(data.frame(female = pct_pref_f, male = pct_pref_m, row.names = c("health", "education", "transport", "watsan","agriculture","private", "other")))
```


## Additional check on preference heterogeneity

Does gender explain variation in preferences at more local levels? To answer this question, we explore variation within lottery bins. Specifically, we conduct an analysis of variance (ANOVA) comparing a model where project preferences are regressed on lottery bins, and a model where project preferences are regressed on lottery bins interacted with gender. We present p-values for F-tests for the null that the interaction term is zero. Except for the private goods category, we cannot reject the null that preferences are the same across gender groups in each of the lottery bin areas in the study.

```{r, echo=TRUE}
any_het <- sapply(pprojects, function(k) {
    M_full <- lm(as.formula(paste(k, "~ female*as.factor(lott_bin)")), 
                                      data = prefsData)
    M_reduced <- lm(as.formula(paste(k, "~ as.factor(lott_bin)")), 
                                      data = prefsData)
    A <- anova(M_reduced, M_full)
    return(c(k, round(A$`Pr(>F)`[[2]],3)))
})

rownames(any_het) <- c("sector","F-test p-value")
colnames(any_het) <- NULL
kable(any_het)

```

## Position in the village (in text)

Presence at a village meeting:
```{r, echo=TRUE}
  
  ind_t <- merge(ABD_INDIV, Tuungane_data, by = "IDV")
  ind_t <- ind_t %>% 
    filter(TUUNGANE == 0) %>%
    mutate(female = 1* (q011_sex == "no"))
  
  presData <- ind_t %>%
    filter(!q079_a_meeting %in% na_answers) %>%
    mutate(q079_a_meeting = 1 * (q079_a_meeting == "yes"))

  pres <- 100*prop.table(table(presData$q079_a_meeting, presData$q011_sex)[,4:5],2)
  colnames(pres) =  c("Women", "Men")
  rownames(pres) =  c("Not present", "Present")
  kable(pres, digits = 2)
  
```

Participated in last village meeting:
```{r, echo = TRUE}

  discData <- ind_t %>%
    filter(!q079_b_discours %in% na_answers) %>%
    mutate(q079_b_discours <- 1* (q079_b_discours == "yes"))
  
  disc <- 100*prop.table(table(discData$q079_b_discours, discData$q011_sex)[,4:5],2)
  disc <- disc[4:5,]
  colnames(disc) =  c("Women", "Men")
  rownames(disc) =  c("Not spoke", "Spoke")
  kable(disc, digits = 2)

```    


## Attitudes towards women by gender (Table 2)

```{r, include=FALSE}

  attsData<-attitudes_control2
  attsData$CDCCODE <- attsData$IDS_CDCCODE
  attsData <- merge(attsData, Lottery, by = "CDCCODE")  
  # only in the 43 bins that had >0 pilot lotteries
  attsData <- filter(attsData, lott_bin_name %in% c("13", "14", "ALUNGULI", "BAKONGOLA", "BAKUNDA", "BALOMOTWA", "BANWESHI", "BASANGA", "BUKAMA", "BUKANDA", "DIFUMA II", "IKOMA", "KABAMBARE", "KAFIRA", "KAMANYOLA", "KAMISIMBI", "KAMPENE", "KARHONGO", "KATAKOKOMBE", "KAYEMBE", "KAYUYU", "KIBANGULA", "KIBOMBO", "KIGOMA", "KIMYAKIMYA", "KINAMA", "KINKUNGWA", "KIONA NGOY", "KISAMAMBA", "KITAMBWE", "LEMERA", "LUCHIGA", "LURHALA", "LUSAMBA", "LUSANGI", "LUVUNGI", "LWAPULA", "MBINGA NORD", "MIKELENGE", "MUHUNGU", "RUNINGU", "SOURCE DU FLEUVE CONGO", "WAMAZA"))

  attsData <- attsData %>%
    filter(TUUNGANE == 0 & IDS_DISTRICT !="TG") %>%
    mutate(female = 1* (q011_sex == "no"))
  

```


```{r, echo = TRUE}

  
attitudes2 <- attitudes[1:4]
Genderatt  <-  sapply(attitudes2, function(y) {
                M <- lm(attsData[,y] ~ female + as.factor(lott_bin.x), data = attsData, na.action="na.exclude")
               output_function(cluster_robust(M, attsData$IDS_CDCCODE))
                 })

Genderatt <- Genderatt[c(1:2,7),]
attitudes_labs2 <- attitudes_labs[1:4]
colnames(Genderatt) <- attitudes_labs2

## Controls means in
means <-  apply(filter(attsData, female==0)[, attitudes2], 2, mean, na.rm=TRUE)

Genderatt <-rbind(Genderatt[1:2,], round(means,3), Genderatt[3,])
row.names(Genderatt) <- c("Parity Effect", "(se)", "Control", "N")

kable(Genderatt)

```




```{r, echo = FALSE, include = FALSE}
T2 <- rbind(
  "\\begin{tabular}{lccccc}",
  "	&	Same rights &	Complain if  &	Socio-admin  	&	Eligible for\\\\",
  "	&	as men	&	mistreated &	positions 	&	president	 \\\\ \\hline \\hline",

  mat_to_tex(Genderatt[,-7], rownames = c("Difference for women", "(se)", "Men", "N")) ,
  "\\hline \\hline \\mc{5}{l}{\\parbox{5in}{\\small\\singlespace  
  \\textit{Notes:} Differences in attitudes by gender. We report sample average treatment effects. Regressions use block fixed effects. Standard errors clustered at the village cluster level. Based on question QG8-QG11. $* p \\le 0.10, ** p \\le 0.05, *** p \\le  0.01$.}
  }",
  "\\label{tab:attdiff}",
  "\\end{tabular}"
)

if(saving){
  sink(paste0(output_folder, "/Table2_attitudesprefs.tex"))
  tablr(T2)
  sink()
}

```




## Perceptions of chief (in text)

Who should do beneficiary selection?
```{r, echo=TRUE}

  respontab <- ind %>%
    filter(q011_sex %in% c("yes", "no")) %>%
    filter(qd002_must_be1 != "") %>%
    group_by(qd002_must_be1) %>%
    summarize(Women = sum(q011_sex == "yes"),
              Men = sum(q011_sex == "no"),
              Combined = n()) %>%
    ungroup()
  
  respontab <- cbind(respontab[,1], apply(respontab[,-1], 2, function(x) 100*prop.table(x)))
  kable(respontab, digits = 2)

```


# Lottery information and manipulation check (Section) 

## Lottery information (Table 3)
Information about block and cluster structure. Table showing the number of clusters in each of the 43 blocks (in rows) and the number of cluster in the parity condition (in columns) according to project data.
```{r, echo=TRUE}

collapsed  <- Lottery %>%
  dplyr::select(lott_bin, pilot_lottery, cdc_parity) %>%
  dplyr::filter(pilot_lottery==1) %>%
  group_by(lott_bin) %>%
  summarise(share = sum(cdc_parity), size = length(cdc_parity)) %>%
  as.data.frame %>%
  dplyr::select(-lott_bin)%>% 
  table

x <- (t(collapsed))
kable(x)
```

```{r export, include = FALSE}
tabcap = "Blocks and clusters"
comm = "\\hline \\hline \\multicolumn{8}{p{5cm}}{Notes: Table shows distribution of the 43 blocks in terms of block size (rows) and the number of clusters in the parity condition (columns) according to project data.}"

x <-  xtable(x, caption = tabcap, label = "tab:bins")

align(x) <- "l|ccccccc"
display(x) <- xdisplay(x)

if(saving){
  fileConn<-file(paste0(output_folder, "/Table3_bins.tex"))
 writeLines(print.xtable(x,
    add.to.row = list(pos = list(10), command = comm), 
    comment = FALSE,
    hline.after=c(0, 0),
    table.placement = "h!",
    caption.placement = "top"), 
  fileConn)
close(fileConn)
}
```


## Manipulation Checks
Based on research data (used in the text), and project data (used as robustness test): 
```{r FirstStage, echo=TRUE, warning = FALSE}
  # First Stage
  # research data
  lm_cluster_robust("femmes~cdc_parity", IRC_tracking[IRC_tracking$pilot_lottery==1,], "IDV_CDCCODE")[[1]]

  # project data
  lm_cluster_robust("femmes~cdv_parity", IRC_tracking[IRC_tracking$pilot_lottery==1,], "IDV_CDCCODE")[[1]]

```


# Core Tables plus robustness checks (Section 5)

We have four core tables on Tuungane project choice, RAPID project choice, behavior and attitudes. We replicate all four tables and with each one provide two robustness results, one using project rather than research team coding on treatment, and the other reporting a LATE analysis with research data (assignment) instrumenting for project data (implementation).

## Tuungane Project Choice (Table 5)

Effects of the parity requirement:
```{r, echo=TRUE, warning=FALSE}

project_choice_main <-
    sapply(projects, function(k) {
      #    sapply(X, function(j) {
      output_function(lm_cluster_robust(paste(k, "~cdc_parity + as.factor(lott_bin)"),
                                        data = IRC_tracking[IRC_tracking$pilot_lottery==1,],
                                        cluster_name = "IDV_CDCCODE"), coefrow = 2) })

means <-  apply(filter(IRC_tracking, cdc_parity==0, pilot_lottery==1)[, projects], 2, mean, na.rm=TRUE)
project_choice_main <-rbind(project_choice_main[1:2,], round(means,3), project_choice_main[3,])

colnames(project_choice_main) <- c("Health", "Education", "Transport", "Watsan", "Agri.")
kable(project_choice_main)
```

### Robustness test: using project coding (Table 14)
Robustness test, substituting project data for research data:
```{r, echo=TRUE}

project_choice_robust <-
    sapply(projects, function(k) {
      #    sapply(X, function(j) {
      output_function(lm_cluster_robust(paste(k, "~cdv_parity + as.factor(lott_bin)"),
                                        data = IRC_tracking[IRC_tracking$pilot_lottery==1,],
                                        cluster_name = "IDV_CDCCODE"), coefrow = 2) })

means2 <-  apply(filter(IRC_tracking, cdv_parity==0, pilot_lottery==1)[, projects], 2, mean, na.rm=TRUE)


project_choice_robust <-   rbind(project_choice_robust[1:2,], round(means2,2), project_choice_robust[3,])

  
colnames(project_choice_robust) <- c("Health", "Education", "Transport", "Watsan", "Agri.")
kable(project_choice_robust)
```

### Robustness test: LATE analysis (Table 18)
Finally, we conduct a LATE analysis by treating the research project records of where parity ought to have been imposed with project records of where in fact it was imposed. There is relatively small non compliance and a very strong first stage. The Table below reports the local average treatment effect for each project.

```{r, echo = TRUE}


  D <- IRC_tracking[c(projects, "pilot_lottery", "cdc_parity", "cdv_parity", "lott_bin", "IDV_CDCCODE")]
  D <- D[complete.cases(D),]

  late_T <- sapply(projects, function(y) {
    D$Y <- as.vector(unlist(D[y]))
    M <- ivreg(Y~cdv_parity + as.factor(lott_bin) | cdc_parity + as.factor(lott_bin), data = D, na.action="na.exclude")
    output_function(cluster_robust(M, D$IDV_CDCCODE))
  })
  projects_labs <- c("Health", "Education", "Transport", "WatSan", "Agric.")
  colnames(late_T) <- projects_labs

  means3 <-  apply(filter(IRC_tracking, cdv_parity==0, pilot_lottery==1)[, projects], 2, mean, na.rm=TRUE)

  late_T <- rbind(late_T[c(1,2),], round(means3,2), late_T[7,])

colnames(late_T) <- c("Health", "Education", "Transport", "Watsan", "Agri.")
kable(late_T, digits = 2)
```

### Additional statistic on omnibus result
To run an omnibus test for the null hypothesis that the choices were the same in parity and nonparity areas we code a variable ``choice`` that takes on a different value for each sector. There is a complication in that some areas chose projects in multiple sectors; to take account of this we create a distinct category for "mixed", which we further refine to "mixed including education"  and "mixed other". In all we have seven categories to which we apply a $\chi^2$  test.

```{r multinomial2, echo = TRUE}
IRC_tracking$choice <- NA
for(j in 1:length(projects)){
  x <- IRC_tracking[projects[j]]
  IRC_tracking$choice[x ==1] <- j
  IRC_tracking$choice[x>0 & x<1]   <- -2
}
IRC_tracking$choice[IRC_tracking$education2 > 0 & IRC_tracking$education2 < 1]  <- -1

proj_table <- table(IRC_tracking$choice, IRC_tracking$cdc_parity)
rownames(proj_table) <- c("Residual category", "Mixed incl education" , projects)
kable(proj_table, col.names = c("Non-parity", "parity"))

print(chisq.test(table(IRC_tracking$choice, IRC_tracking$cdc_parity)))
print(chisq.test(table(IRC_tracking$choice, IRC_tracking$cdv_parity)))
```

We fail to reject the null that the distribution across these seven categories is different in treatment and control ($p$ = `r chisq.test(table(IRC_tracking$choice, IRC_tracking$cdc_parity))[3]`). Using the project report of where parity was implemented (project data) we have a lower $p$ value of $p$ = `r chisq.test(table(IRC_tracking$choice, IRC_tracking$cdv_parity))[3]`.

### Tuungane project choice only for the 105 RAPID villages under study (Table 12)
```{r, echo=FALSE}
  
  IRC_trackingRAPID<-IRC_tracking
  IRC_trackingRAPID <- dplyr::filter(IRC_trackingRAPID, IDV_CDCCODE==1101 | IDV_CDCCODE==1104 | IDV_CDCCODE==1106 | IDV_CDCCODE==1108 | IDV_CDCCODE==1110 | IDV_CDCCODE==1112 | IDV_CDCCODE==1114 | IDV_CDCCODE==1148 | IDV_CDCCODE==1202 | IDV_CDCCODE==1203 | IDV_CDCCODE==1207 | IDV_CDCCODE==1209 | IDV_CDCCODE==1212 | IDV_CDCCODE==1213 | IDV_CDCCODE==1216 | IDV_CDCCODE==1217 | IDV_CDCCODE==1220 | IDV_CDCCODE==1222 | IDV_CDCCODE==1312 | IDV_CDCCODE==1313 | IDV_CDCCODE==1315 | IDV_CDCCODE==1319 | IDV_CDCCODE==1322 | IDV_CDCCODE==1323 | IDV_CDCCODE==1326 | IDV_CDCCODE==1329 | IDV_CDCCODE==1338 | IDV_CDCCODE==1339 | IDV_CDCCODE==1401 | IDV_CDCCODE==1404 | IDV_CDCCODE==1406 | IDV_CDCCODE==1410 | IDV_CDCCODE==1413 | IDV_CDCCODE==1417 | IDV_CDCCODE==1419 | IDV_CDCCODE==1422 | IDV_CDCCODE==1423 | IDV_CDCCODE==1425 | IDV_CDCCODE==1426 | IDV_CDCCODE==1427 | IDV_CDCCODE==1430 | IDV_CDCCODE==1433 | IDV_CDCCODE==1436 | IDV_CDCCODE==1437 | IDV_CDCCODE==1438 | IDV_CDCCODE==1444 | IDV_CDCCODE==1445 | IDV_CDCCODE==1449 | IDV_CDCCODE==1450 | IDV_CDCCODE==2242 | IDV_CDCCODE==2247 | IDV_CDCCODE==2248 | IDV_CDCCODE==2250 | IDV_CDCCODE==2252 | IDV_CDCCODE==2301 | IDV_CDCCODE==2306 | IDV_CDCCODE==2307 | IDV_CDCCODE==2316 | IDV_CDCCODE==2320 | IDV_CDCCODE==2326 | IDV_CDCCODE==2426 | IDV_CDCCODE==4113 | IDV_CDCCODE==4114 | IDV_CDCCODE==4147 | IDV_CDCCODE==4149 | IDV_CDCCODE==4150 | IDV_CDCCODE==4151 | IDV_CDCCODE==4154 | IDV_CDCCODE==4156 | IDV_CDCCODE==4157 | IDV_CDCCODE==4158 | IDV_CDCCODE==4162 | IDV_CDCCODE==4168 | IDV_CDCCODE==4169 | IDV_CDCCODE==4170 | IDV_CDCCODE==4171 | IDV_CDCCODE==4173 | IDV_CDCCODE==4174 | IDV_CDCCODE==4175 | IDV_CDCCODE==4177 | IDV_CDCCODE==4214 | IDV_CDCCODE==4217 | IDV_CDCCODE==4219 | IDV_CDCCODE==4222 | IDV_CDCCODE==4226 | IDV_CDCCODE==4230 | IDV_CDCCODE==4231 | IDV_CDCCODE==4257 | IDV_CDCCODE==4308 | IDV_CDCCODE==4309 | IDV_CDCCODE==4318 | IDV_CDCCODE==4323 | IDV_CDCCODE==4325 | IDV_CDCCODE==4326 | IDV_CDCCODE==4327 | IDV_CDCCODE==4340 | IDV_CDCCODE==4341 | IDV_CDCCODE==4345 | IDV_CDCCODE==4346 | IDV_CDCCODE==4347 | IDV_CDCCODE==4348 | IDV_CDCCODE==4350 | IDV_CDCCODE==4353 | IDV_CDCCODE==4355 | IDV_CDCCODE==4361)
  
    

```

```{r, echo = TRUE}
  
project_choice_mainRAPID  <- sapply(projects, function(k) {
      output_function(lm_cluster_robust(paste(k, "~cdc_parity + as.factor(lott_bin)"),
                                        data = IRC_trackingRAPID[IRC_trackingRAPID$pilot_lottery==1,],
                                        cluster_name = "IDV_CDCCODE"), coefrow = 2) })
  
  
means <-  apply(filter(IRC_trackingRAPID, cdc_parity==0, pilot_lottery==1)[, projects], 2, mean, na.rm=TRUE)
project_choice_mainRAPID <-rbind(project_choice_mainRAPID[1:2,], round(means,3), project_choice_mainRAPID[3,])
  
colnames(project_choice_mainRAPID) <- c("Health", "Education", "Transport", "Watsan", "Agri.")
rownames(project_choice_mainRAPID) <- c("Parity Effect", "(se)", "Control", "N")

kable(project_choice_mainRAPID, digits = 2)

```



```{r, echo=FALSE}

# This file makes the the main table, and the two robustness tables
source("R/Table5_tuungane.R")

```
## RAPID project choice (Table 6)

Share of projects chosen under RAPID
```{r, echo = TRUE}
abs <- colSums(rapid_projects[rapid_projects$pilot_lottery==1,c(RAPIDprojects, "RAPIDother")], na.rm=TRUE)
share_choice <- abs/sum(abs)
kable(share_choice)
```

Replicate Table 6 on the effects of the parity requirement on RAPID project choice:
```{r, echo =TRUE}

project_choice_rapid <-
  sapply(RAPIDprojects, function(k) {
    output_function(lm_cluster_robust(paste(k, "~cdc_parity + as.factor(lott_bin)"),
                                      data = rapid_projects[rapid_projects$pilot_lottery==1,],
                                      cluster_name = "IDV_CDCCODE"), coefrow = 2) })

## Controls means in
rap_means <-  apply(filter(rapid_projects, cdc_parity==0, pilot_lottery==1)[, RAPIDprojects], 2, mean, na.rm=TRUE)
project_choice_rapid <-rbind(project_choice_rapid[1:2,], round(rap_means,3), project_choice_rapid[3,])

colnames(project_choice_rapid) <- c("Health", "Education", "Transport", "Watsan", "Agri.", "Private")
kable(project_choice_rapid)
```

### Robustness test: using project coding (Table 15)
Robustness test, substituting project data for research data:
```{r, echo = TRUE}

project_choice_rapid_project <-
    sapply(RAPIDprojects, function(k) {
      output_function(lm_cluster_robust(paste(k, "~cdv_parity + as.factor(lott_bin)"),
                                        data = rapid_projects[IRC_tracking$pilot_lottery==1,],
                                        cluster_name = "IDV_CDCCODE"), coefrow = 2) })
  project_choice_rapid_project
  rap_means2 <-  apply(filter(rapid_projects, cdv_parity==0, pilot_lottery==1)[, RAPIDprojects], 2, mean, na.rm=TRUE)
  project_choice_rapid_project <-rbind(project_choice_rapid_project[1:2,], round(rap_means2,3), project_choice_rapid_project[3,])

colnames(project_choice_rapid_project) <- c("Health", "Education", "Transport", "Watsan", "Agri.", "Private")
kable(project_choice_rapid_project)
```

### Robustness test: LATE analysis (Table 19)
LATE analysis again done using IV on all outcome variables where researcher lottery data is an instrument for the implementation recording on committee structure.


```{r RAPID_LATE, echo=TRUE}
D <- rapid_projects[rapid_projects$pilot_lottery==1,][c(RAPIDprojects,  "cdc_parity", "cdv_parity", "lott_bin", "IDV_CDCCODE")]

  D <- D[complete.cases(D),]

  late_R <- sapply(RAPIDprojects, function(y) {
    D$Y <- as.vector(unlist(D[y]))
    M <- ivreg(Y~cdv_parity + as.factor(lott_bin) | cdc_parity + as.factor(lott_bin), data = D, na.action="na.exclude")
    output_function(cluster_robust(M, D$IDV_CDCCODE))
  })

    colnames(late_R) <-  RAPID_projects_labs
    rap_means3 <-  apply(filter(rapid_projects, cdv_parity==0, pilot_lottery==1)[, RAPIDprojects], 2, mean, na.rm=TRUE)
    late_R <-rbind(late_R[1:2,], round(rap_means3,3), late_R[7,])

kable(late_R, digits = 2)
```

```{r, echo=FALSE}
source("R/Table6_rapid.R")

```

### Additional analysis on RAPID project preferences (Table 13, Appendix E)
Do women's stated preferences translate into project choices at higher rates (relative to
men's preferences) in parity areas? The next table shows the results.
```{r, echo=FALSE, warning=FALSE}

source("R/Table13_maledominance.R")

male_dominance <- cbind(c("Parity Condition", "(se)", "Male", "(se)", "Interaction", "(se)", "N"), male_dominance)

kable(male_dominance, col.names=c("","Course measure","Fine measure"))

```


### Additional statistic on omnibus result

```{r multinomial, echo=TRUE}
rapid_projects$choice <- NA
for(j in 1:length(RAPIDprojects)){
  x <- rapid_projects[RAPIDprojects[j]]
  rapid_projects$choice[x ==1] <- j
}

rproj_table <- table(rapid_projects$choice, rapid_projects$cdc_parity)
rownames(rproj_table) <- c(RAPIDprojects)
kable(rproj_table, col.names = c("Non-parity", "parity"))

print(chisq.test(table(rapid_projects$choice, rapid_projects$cdc_parity)))
print(chisq.test(table(rapid_projects$choice, rapid_projects$cdv_parity)))
```

## Other Behavioral Results Based on RAPID

Share of interventions by women in RAPID committees (in text):
```{r, echo=TRUE}
int <- discussion_gender_village %>% group_by(cdc_parity) %>% summarize(`share of interventions by women`= mean(female, na.rm=TRUE))
kable(int)
```

Average RAPID committee size (in text):
```{r, echo=TRUE}
avg_n <- round(with(committee_gender, mean(men[!is.na(share_women)] + women[!is.na(share_women)], na.rm = TRUE)), 3)
avg_women <- round(with(committee_gender, mean(women[!is.na(share_women)], na.rm = TRUE)), 3)
kable(rbind(avg_n, avg_women))
```

Number of gender-balanced committes by participation in Tungane (in text):

```{r, echo=TRUE}
committee_gender %>% subset(!is.na(share_women)) %>% group_by(women) %>% summarise(pct = n()/nrow(.))

t <- table(committee_gender$share_women == .0, committee_gender$cdc_parity)
t <- table(committee_gender$share_women >= .5, committee_gender$cdc_parity)
rownames(t) <- c("Share women < .5", "Share women >= .5")
colnames(t) <- c("Non-Parity", "Parity")
kable(t)
```

### Effects of the parity requirement (Table 7)
```{r, echo=TRUE, warning=FALSE}

tab_input <- cbind(
              mapply(
                df   = list(meetings_gender, discussion_gender_village, committee_gender),
                depvar = c("sharewomenA", "female", "share_women"),
                          
                  function(df, depvar){
                    col <- output_function( 
                              lm_cluster_robust(paste0(depvar, "~ cdc_parity + as.factor(lott_bin)"),
                              data = df,
                              cluster_name = "IDV_CDCCODE"), 
                            coefrows=2)
                    col <- c(col[1:2], format(round(mean(df[df$cdc_parity==0 & df$pilot_lottery==1, depvar], na.rm = TRUE),3), nsmall=3),col[3])
                            
                   return(col)
                   }))

colnames(tab_input) <- c("Present", "Interventions", "Composition")
rownames(tab_input) <- c("Effect", "se", "Control", "N")

kable(tab_input)
```

### Robustness test: using project coding (Table 16)
Robustness test, substituting project data for research data:
```{r BehRob, echo=TRUE}
tab_input2 <- cbind(
                mapply(
                  df = list(meetings_gender, discussion_gender_village, committee_gender),
                  depvar = c("sharewomenA", "female", "share_women"),
                  
                  function(df, depvar){
                    col <- output_function(
                      lm_cluster_robust(paste0(depvar, "~cdv_parity + as.factor(lott_bin)"),
                                                                      data = df, cluster_name = "IDV_CDCCODE"),       
                          coefrows=2)
                    col <- c(col[1:2], format(round(mean(df[df$cdv_parity==0 & df$pilot_lottery==1, depvar], na.rm = TRUE),3), nsmall=3), col[3])
                      return(col)
                  }))

colnames(tab_input2) <- c("Present", "Interventions", "Composition")
rownames(tab_input2) <- c("Effect", "se", "Control", "N")

kable(tab_input2)
```


### Robustness test: LATE analysis (Table 20)
LATE analysis again done using IV on all outcome variables where researcher lottery data is an instrument for the implementation recording on committee structure.
```{r BehLATE, echo=TRUE}
tab_inputLATE <- cbind(mapply(df = list(meetings_gender, discussion_gender_village, committee_gender),
                           depvar = c("sharewomenA", "female", "share_women"),
                           
                           function(df, depvar){
                             D <- df[,c(depvar, "cdv_parity", "cdc_parity", "lott_bin", "IDV_CDCCODE")]
                             D <- D[complete.cases(D),]
                             M <- ivreg(as.formula(paste(depvar, "~ cdv_parity + as.factor(lott_bin) | cdc_parity + as.factor(lott_bin)")),  data = D, na.action="na.exclude")
                             col <-  output_function(cluster_robust(M, D$IDV_CDCCODE))
                             col <- c(col[1:2],
                                      format(round(mean(df[df$cdv_parity==0 & df$pilot_lottery==1, depvar], na.rm = TRUE),3)),
                                      col[rownames(col)=="N"])
                             return(col)
                           }))

colnames(tab_inputLATE) <- c("were present", "spoke", "were on committee")
rownames(tab_inputLATE) <- c("Estimate", "se.", "Nonparity", "N")

colnames(tab_inputLATE) <- c("Present", "Interventions", "Composition")
rownames(tab_inputLATE) <- c("Effect", "se", "Control", "N")
kable(tab_inputLATE, digits = 3)
```

```{r, echo=FALSE}
source("R/Table7_otherbehavior.R")
```

## Attitudes towards women (Table 8)

Replicate Table 8 on the effects of the parity requirement:
```{r, echo=TRUE}

attitudes_table <-
  sapply(attitudes, function(k) {
    output_function(lm_cluster_robust(paste(k, "~cdc_parity + as.factor(lott_bin)"),
                                      data = attitudes_data,
                                      cluster_name = "IDV_CDCCODE"), coefrows=2)})

## Controls means in
means <-  apply(filter(attitudes_data, cdc_parity==0, pilot_lottery==1)[, attitudes], 2, mean, na.rm=TRUE)
attitudes_table <-rbind(attitudes_table[1:2,], round(means,3), attitudes_table[3,])

colnames(attitudes_table) <- c("Same right", "Complain", "Positions", "President", "Index")
rownames(attitudes_table) <- c("Effect", "se", "Control", "N")

kable(attitudes_table)
```

### Robustness test: using project coding (Table 17)
Robustness test, substituting project data for research data:
```{r, echo=TRUE}
## BASED ON PROJECT DATA
attitudes_tableR <-
  sapply(attitudes, function(k) {
    output_function(lm_cluster_robust(paste(k, "~cdv_parity + as.factor(lott_bin)"),
                                      data = attitudes_data,
                                      cluster_name = "IDV_CDCCODE"))})

means <-  apply(filter(attitudes_data, cdv_parity==0, pilot_lottery==1)[, attitudes], 2, mean, na.rm=TRUE)
attitudes_tableR <-rbind(attitudes_tableR[1:2,], round(means,3), attitudes_tableR[7,])

colnames(attitudes_tableR) <- c("Same right", "Complain", "Positions", "President", "Index")
rownames(attitudes_tableR) <- c("Effect", "se", "Control", "N")

kable(attitudes_tableR)
```


### Robustness test: LATE analysis (Table 21)
LATE analysis again done using IV on all outcome variables where researcher lottery data is an instrument for the implementation recording on committee structure.
```{r, echo=TRUE}

## LATE

late_A <- sapply(attitudes, function(y) {
  D <- attitudes_data[attitudes_data$pilot_lottery==1,][c(y,  "cdc_parity", "cdv_parity", "lott_bin", "IDV_CDCCODE")]
  D <- D[complete.cases(D),]

  D$Y <- as.vector(unlist(D[y]))
  M <- ivreg(Y~cdv_parity + as.factor(lott_bin) | cdc_parity + as.factor(lott_bin), data = D, na.action="na.exclude")
  output_function((cluster_robust(M, D$IDV_CDCCODE)))
})

meansL <-  apply(filter(attitudes_data, cdv_parity==0, pilot_lottery==1)[, attitudes], 2, mean, na.rm=TRUE)
late_A <-rbind(late_A[1:2,], round(meansL,3), late_A[7,])

colnames(late_A) <- c("Same right", "Complain", "Positions", "President", "Index")
rownames(late_A) <- c("Effect", "se", "Control", "N")
 kable(late_A, digits = 2)
```







```{r, echo=FALSE}
source("R/Table8_attitudes.R")

```
## Balance test (Table 10, Appendix B)
Balance test shows mean and standard deviation for parity and nonparity areas. We also present results from a test of the difference in means, where we use block fixed effects and cluster errors at the village cluster level. Distance data based on individual responses, mean aggregated to the village level. Data on infrastructure, migration and village committees comes from the village chief. Gender and age from respondents. In total, 172 of the 200 village chiefs could be interviewed during Step D. Furthermore, a number of responses are: "Don't know", "Not Applicable" and "Refuses to respond". 

```{r, warning=FALSE,  include=FALSE}


#################
# Distance from... 
# asked to all respondents during Step D. Target= 200 observations
#################

# Loop over all
distvars <-  c("qe013_a_water", "qe013_b_market", "qe013_c_public_transport", "qe013_d_prim_school", "qe013_e_sec_school", "qe013_f_health", "qe013_g_pharmacy", "qe013_h_clinique", "qe013_i_mine", "qe013_j_post", "qe013_k_chef_chefferie")

distchief <- dplyr::filter(ind, pilot_lottery ==1)

for(j in distvars){
  H <- distchief[,paste0(j, "_hrs")]
  H[H<0] <- NA
  M <- distchief[,paste0(j, "_mns")]
  M[M<0] <- NA
  distchief[j] <- round(H+M/60,2)
}

disdata <- distchief[, c(distvars, "qe013_k_chef_chefferie", "cdc_parity", "lott_bin", "IDV_CDCCODE", "IDV") ]
disdata <-   aggregate(. ~ IDV , data = disdata, FUN = mean, na.rm = TRUE)

distance_balance <- sapply(distvars, function(j) {
    Pm   <-  mean(disdata[,j][disdata$cdc_parity==1])
    NPm  <-  mean(disdata[,j][disdata$cdc_parity==0])
    Psd  <- sd(disdata[,j][disdata$cdc_parity==1])
    NPsd <- sd(disdata[,j][disdata$cdc_parity==0])
    M    <- lm(paste(j, "~ cdc_parity + as.factor(lott_bin)"), na.action="na.exclude", data = disdata)
    M2   <- cluster_robust(M, disdata$IDV_CDCCODE)
    
    c("Mean Parity" = Pm, "
      SD P" = Psd,
      "Mean NP"= NPm,
      "SD NP"= NPsd, 
      M2[[1]]["cdc_parity",c(1 ,2,4 )],
      N = M2[[2]][1])
})

colnames(distance_balance) <- c("Distance water source", "Distance market", "Distance transport", "Distance primary school", "Distance secondary school", "Distance clinic/hospital", "Distance pharmacy", "Distance maternity clinic", "Distance mine", "Distance police post", "Distance chiefdom HQ")
#kable(t(distance_balance), digits = 3)
```

```{r,  include=FALSE}
#################
# Infrastructure in 2006 (asked to chief only during Step D). Target= 200 observations
#################

infra <- merge(vill_data, Lottery, all = TRUE, by = "IDV_CDCCODE")
infra <- dplyr::filter(infra, pilot_lottery ==1)

infra_vars <- c("cq023_a1_wells_2006", "cq024_a1_schools_2006", "cq025_a1_cliniques_2006", "cq026_a1_churches_2006", "cq027_a1_halls_2006")

infra_balance <- sapply(infra_vars, function(j) {
    x <- infra[,j]  
    x[x<0] <- NA
    Pm <- mean(x[infra$cdc_parity==1], na.rm=TRUE)
    NPm <- mean(x[infra$cdc_parity==0], na.rm=TRUE)
    Psd <- sd(x[infra$cdc_parity==1], na.rm=TRUE)
    NPsd <- sd(x[infra$cdc_parity==0], na.rm=TRUE)
    M <- lm(x ~ cdc_parity + as.factor(lott_bin), data = infra, na.action="na.exclude")
    M2 <- cluster_robust(M, infra$IDV_CDCCODE)
    
    c("Mean Parity" = Pm,
      "SD Parity" = Psd, 
      "Mean Nonparity"= NPm, 
      "SD Nonparity"= NPsd,
      M2[[1]]["cdc_parity",c(1,2,4)], 
      N = M2[[2]][1])
    })

  colnames(infra_balance) <- c("Wells in 2006", "Schools in 2006", "Clinics in 2006", "Churches in 2006", "Halls in 2006")
#kable(t(infra_balance), digits = 2)

```




```{r, include=FALSE}
#################
# Migration into the village in 2006 (asked to chief only during Step D). Target= 200 observations
#################

  migdata <- merge(vill_data, Lottery, all = TRUE, by = "IDV_CDCCODE")
  migdata <- dplyr::filter(migdata, pilot_lottery ==1)

  mig_vars <- c("cq0136_idp_2006", "cq0137_idp_returned_2006", "cq0138_refugie_2006", "cq0139_refugie_repat_2006")
  mig_balance <- sapply(mig_vars, function(j) {
                  x <- migdata[,j]  
                  x[x<0] <- NA
                  Pm <- mean(x[migdata$cdc_parity==1], na.rm=TRUE)
                  NPm <- mean(x[migdata$cdc_parity==0], na.rm=TRUE)
                  Psd <- sd(x[migdata$cdc_parity==1], na.rm=TRUE)
                  NPsd <- sd(x[migdata$cdc_parity==0], na.rm=TRUE)
                  M <- lm(x~cdc_parity + as.factor(lott_bin), data = migdata, na.action="na.exclude")
                  M2 <- cluster_robust(M, migdata$IDV_CDCCODE)
    
                  c("Mean Parity" = Pm,
                    "SD Parity" = Psd, 
                    "Mean Nonparity"= NPm,
                    "SD Nonparity"= NPsd, 
                    M2[[1]]["cdc_parity",c(1,2,4)],
                    N = M2[[2]][1])
                  })
  colnames(mig_balance) <- c("IDPs in 2006", "IDPs returned in 2006", "Refugees in 2006", "Refugees Repatriated in 2006")
#kable(t(mig_balance), digits = 2)
  
  
```

```{r, include=FALSE}
#################
# Gender (asked to roster during Step D). Target= 97*5 + 103*10=1515 observations
# Age (asked to roster during Step D). Target= 97*5 + 103*10=1515 observations
#################

  genderdata <- roster %>%
                dplyr::rename(IDV_CDCCODE = IDS_CDCCODE) %>%
                merge( Lottery, all = TRUE, by = "IDV_CDCCODE") %>%
                dplyr::filter( pilot_lottery ==1) %>%
                dplyr::mutate(male =qf007_gender == "yes",
                              age = ifelse(2011 - as.numeric(qf009_birthyear) < 200,
                                           2011 - as.numeric(qf009_birthyear),
                                           NA))

  genderage_balance <- sapply(c("male", "age"), function(j) {
                          x <- genderdata[,j]  
                          x[x<0] <- NA
                          Pm <- mean(x[genderdata$cdc_parity==1], na.rm=TRUE)
                          NPm <- mean(x[genderdata$cdc_parity==0], na.rm=TRUE)
                          Psd <- sd(x[genderdata$cdc_parity==1], na.rm=TRUE)
                          NPsd <- sd(x[genderdata$cdc_parity==0], na.rm=TRUE)
                          M <- lm(x~cdc_parity + as.factor(lott_bin), data = genderdata, na.action="na.exclude")
                          M2 <- cluster_robust(M, genderdata$IDV_CDCCODE)
                          c("Mean Parity" = Pm,
                            "SD Parity" = Psd, 
                            "Mean Nonparity"= NPm,
                            "SD Nonparity"= NPsd, 
                            M2[[1]]["cdc_parity",c(1,2,4)],
                            N = M2[[2]][1])
    })

colnames(genderage_balance) <- c("Share of men", "Average age")
#kable(t(genderage_balance), digits = 2)

```



```{r, include=FALSE}

# Output balance table
  
  balancetogether <- cbind(distance_balance, infra_balance, mig_balance, genderage_balance)
  rownames(balancetogether) <- c("Parity", "Sd.", "Nonparity", "Sd.", "Diff.", "Se.", "P-value", "N")


tabcap = "Balance Test"
comm <- "\\hline \\hline \\multicolumn{9}{p{16cm}}{Notes: Balance information. Regressions use block fixed effects. Standard errors clustered at the village cluster level. $* p \\le 0.10, ** p \\le 0.05, *** p\\le  0.01$.}"

x <- xtable(
            round(t(balancetogether),2), 
            caption = tabcap,
            label = "tab:balance"
            )
align(x) <- xalign(x)
digits(x) <- xdigits(x)
display(x) <- xdisplay(x)

if(saving){
fileConn<-file(paste0(output_folder, "/Table_Balance.tex"))
 writeLines(print.xtable(
     x ,
    add.to.row = list(pos = list(22), command = comm), 
    comment = FALSE,
    hline.after=c(0, 0, 11, 16, 20),
    table.placement = "h!",
    caption.placement = "top"), 
  fileConn)
close(fileConn)
}
```

```{r, echo=FALSE, results='asis'}
kable(x )
```


# Attrition analysis (Table 11, Appendix C)
We show missing data for all measures in the result tables, and check whether missingness is related to parity status.


```{r, echo = FALSE}

# Target 661, but 7 missing

T_missing <- sapply(projects, function(y) {
  D <- IRC_tracking[IRC_tracking$pilot_lottery==1,]
  D$missing <- is.na(D[y])
  D$Number <- !is.na(D[y])
  M <- lm(missing ~ cdc_parity + as.factor(lott_bin), data = D)
  c(Target = sum(D$Number) + sum(D$missing),
    Number=sum(D$Number),
    N_missPar = sum(D$missing[D$cdc_parity==1]),
    N_missNotP = sum(D$missing[D$cdc_parity==0]),
    cluster_robust(M, IRC_tracking$IDV_CDCCODE)[[1]]["cdc_parity",])
 })

row.names(T_missing) <- c("Target","Number","Missing Parity","Missing Nonparity","Beta","(se)","7","8")


```

```{r, echo=FALSE}

# RAPID project choice: based on step B. 
# Target =149. Only 105 with data

R_missing <- sapply(RAPIDprojects, function(y) {
  D <- rapid_projects[rapid_projects$pilot_lottery==1 & rapid_projects$IDV_RAPID==1,]
  D$missing <- is.na(D[y])
  D$Number  <- !is.na(D[y])
  M <- lm(missing ~ cdc_parity + as.factor(lott_bin), data = D)
  c(Target=sum(D$Number) + sum(D$missing),
    Number=sum(D$Number), 
    N_missPar = sum(D$missing[D$cdc_parity==1]),
    N_missNotP = sum(D$missing[D$cdc_parity==0]), 
    cluster_robust(M, D$IDV_CDCCODE)[[1]]["cdc_parity",])
 })

row.names(R_missing) <-c("Target","Number","Missing Parity","Missing Nonparity","Beta","(se)","7","8")



```


```{r, echo=FALSE}

# RAPID behavior: based on step A/B. 
# Target =149. Only 105 with data (for 1 indicator we drop an outlier so 104)

  # women present
  D <- meetings_gender[meetings_gender$IDV_RAPID==1,]
  D$missing <- 1*is.na(D$sharewomenA)
  D$Number <- 1*!is.na(D$sharewomenA)
  M <- lm(missing ~ cdc_parity + as.factor(lott_bin), data = D)
  miss1 <-  c(Target=sum(D$Number)+sum(D$missing), Number=sum(D$Number), N_missPar = sum(D$missing[D$cdc_parity==1]), N_missNotP = sum(D$missing[D$cdc_parity==0]), cluster_robust(M, D$IDV_CDCCODE)[[1]]["cdc_parity",])

  # women participation
  D <- dplyr::filter(discussion_gender_village, IDV_RAPID==1 & !is.na(IDV_RAPID))
  D$missing <- 1*is.na(D$female)
  D$Number <- 1*!is.na(D$female)
  M <- lm(missing~cdc_parity + as.factor(lott_bin), data = D)
  miss2 <- c(Target=sum(D$Number)+sum(D$missing), Number=sum(D$Number), N_missPar = sum(D$missing[D$cdc_parity==1]), N_missNotP = sum(D$missing[D$cdc_parity==0]), cluster_robust(M, D$IDV_CDCCODE)[[1]]["cdc_parity",])
  
  # composition  
  D <- dplyr::filter(committee_gender, IDV_RAPID==1 & !is.na(IDV_RAPID))
  D$missing <- 1*is.nan(D$share_women)
  D$Number <- 1*!is.na(D$share_women)
  M <- lm(missing~cdc_parity + as.factor(lott_bin), data = D)
  miss3 <- c(Target =sum(D$Number)+sum(D$missing), 
             Number =sum(D$Number), 
             N_missPar = sum(D$missing[D$cdc_parity==1]), 
             N_missNotP = sum(D$missing[D$cdc_parity==0]),
             cluster_robust(M, D$IDV_CDCCODE)[[1]]["cdc_parity",])

  miss <- cbind(miss1, miss2, miss3)
  row.names(miss) <-c("Target","Number","Missing Parity","Missing Nonparity","Beta","(se)","7","8")
  colnames(miss) <- c("Women present", "Women's spoke", "were on committee")

```


```{r, echo=FALSE}

# Attitudes. Target 1490. Only in the 900s observations.

attitudes2 <- c("qg008_women2", "qg009_mistreatment2", "qg010_socioadmin2", "qg011_women_pres2")

Atts <- sapply(attitudes2, function(y) {
  D <- attitudes_data
  D$missing <- is.na(D[y])
  D$Number <- !is.na(D[y])
  M <- lm(missing ~ cdc_parity + as.factor(lott_bin), data = D)
  #c(N_missing = sum(D$missing) , cluster_robust(M, D$IDV_CDCCODE)[[1]][2,])
  c(Target=sum(D$Number)+sum(D$missing),
    Number=sum(D$Number),
    N_missPar = sum(D$missing[D$cdc_parity==1]),
    N_missNotP = sum(D$missing[D$cdc_parity==0]),
    cluster_robust(M, D$IDV_CDCCODE)[[1]]["cdc_parity",])
 })

row.names(Atts) <-c("Target","Number","Missing Parity","Missing Nonparity","Beta","(se)","7","8")


```


```{r, include=FALSE}

# Output attrition table
  
  attrition <- cbind(T_missing, R_missing, miss, Atts)
  attrition <- attrition[1:6,]
  #tables <- c(rep("T",5),rep("T",6),rep("T",3),rep("T",4))
  #attrition <- rbind(tables,attrition)

  attrition <- t(attrition)
  #c(rep("T",5),rep("T",6),rep("T",3),rep("T",4))
  rownames(attrition) <- c("Table 5: Health", 
                           "Table 5: Education",
                           "Table 5: Transport",
                           "Table 5: Watsan",
                           "Table 5: Agri.",
                           "Table 6: Health",
                           "Table 6: Education",
                           "Table 6: Transport",
                           "Table 6: Watsan",
                           "Table 6: Agri.",
                           "Table 6: Private",
                           "Table 7: Were present",
                           "Table 7: Spoke",
                           "Table 7: Committee",
                           "Table 8: Same rights",
                           "Table 8: Complain",
                           "Table 8: Socio-admin",
                           "Table 8: President")


tabcap = "Overview Attrition and Missing Responses"
comm <- "\\hline \\hline \\multicolumn{7}{p{16cm}}{Table presents number of targeted observations, number of observations used for analyses, and difference between both across treatment condition. Standard errors clustered at the village cluster level. $* p \\le 0.10, ** p \\le 0.05, *** p\\le  0.01$. Related to Table 5, project documents missed information about project choice for 7 out of 661 VDCs. Imbalance is due to 4 VDCs being in one cluster. Related to Table 6, Step B: expulsion from Maniema province (41 villages); data loss 3 villages. Related to Table 7, Step A: expulsion from Maniema (39), data loss 5 villages. One village recorded 4014 men present, which we believe is an error. Related to Table 8, Step D: expulsion from Maniema (98). Per indicator: 4 NAs, 18 DKs, 1 RRs; 2 NAs, 29 DKs; 3 NAs, 14 DKs, 3 RRs; 4 NAs, 13 DKs. For all indicators: no data for 65 households.}"

x <- xtable(
            round(attrition,3), 
            caption = tabcap,
            label = "tab:attrition"
            )
align(x) <- xalign(x)
digits(x) <- xdigits(x)
display(x) <- xdisplay(x)

if(saving){
fileConn<-file(paste0(output_folder, "/Table_Attrition.tex"))
 writeLines(print.xtable(
     x ,
    add.to.row = list(pos = list(18), command = comm), 
    comment = FALSE,
    hline.after=c(0, 0, 5, 11, 14),
    table.placement = "h!",
    caption.placement = "top"), 
  fileConn)
close(fileConn)
}



```



```{r, echo=FALSE, results='asis'}
kable(x)
```

# Composition of committees

```{r, include=FALSE}
  roster$years_edu = plyr::revalue(roster$qf013_education , c( 
                            "other" = NA,
                            "refuses to respond" = NA,
                            "don't know" = 0L ,
                            "not applicable" = 0L,
                            "none or before primary" = 0,
                            "1 first year primary" =  1,
                            "second year primary"  =  2,
                            "third year primary" = 3,
                            "fourth year primary" = 4,
                            "fifth year primary" = 5,
                            "sixth year primary" = 6,
                            "first year secondary" = 7,
                            "second year secondary" = 8,
                            "third year secondary" = 9,
                            "fourth year secondary" = 10,
                            "fifth year secondary" = 11,
                            "sixth year secondary" = 12,
                            "university g1" = 13,
                            "university g2" = 14,
                            "university g3" = 15,
                            "professional education" = 12,
                            "technical education" = 12)) 


tab23_DF <- vill_data  %>%
              merge(Tuungane_data, by = "IDV") %>%
              merge(DRC2012_ABD_INDIV, by = "IDV") %>%
              merge(roster, by = "IDS" ) %>%
              dplyr::select(IDV = IDV.x,
                     IDS, 
                     IDS_TYPES = IDS_TYPES.x,
                     years_edu,
                     qe002_material_roof,
                     qf009_birthyear, 
                     sp001_born_here,
                     qf007_gender, 
                     IDO,
                     IDS_CDCCODE = IDS_CDCCODE.x,
                     CDCCODE = IDV_CDCCODE) %>%
              merge(Lottery, by = "CDCCODE") %>%
              mutate(member =  ifelse(IDS_TYPES == "DCDV", 1, 
                                      ifelse( IDS_TYPES=="DML", 0,  NA)),
                     gender = (qf007_gender == "yes")*1,
                     metalroof = ifelse(qe002_material_roof == "", NA, (qe002_material_roof=="4 Metal")*1),
                     bornhere  = ifelse(sp001_born_here == "yes", 1, ifelse(sp001_born_here == "no", 0, NA)),
                     qf009_birthyear     = as.numeric(qf009_birthyear), 
                     years_edu = as.numeric(years_edu)) %>% 
              mutate(age       = ifelse(qf009_birthyear < 0, NA, 2012 - qf009_birthyear)) %>%
              mutate(age2 = age*age)    %>%
              filter(IDO == 101  & pilot_lottery == 1)


                        
```


## Frequency Table by Gender and Membership (in text)
```{r}
t <- tab23_DF %>%
     mutate(gender = ifelse(gender == 0, "female", "male"),
            member = ifelse(member == 0, "non-member", "member"))

kable(with(t, addmargins(table( member, gender))))
```

## Women's Observations with no Missing Values (in text)
```{r}

tab23_DF <- tab23_DF %>%
              filter(gender == 0) %>%
              filter(complete.cases(.))

nrow(tab23_DF)
```

## Determinants of VDC Committee Membership (Table 23)
```{r}
pe <- probitmfx(formula = 
                  member ~  metalroof + age + age2 + bornhere + years_edu + cdc_parity + years_edu*cdc_parity ,
                 data = tab23_DF, atmean = TRUE,
                 robust = TRUE, clustervar1 =  "IDS_CDCCODE" )

stars <- ifelse(pe$mfxest[,"P>|z|"] <= .01, "***", 
                ifelse(pe$mfxest[,"P>|z|"] <= .05, "**", 
                       ifelse(pe$mfxest[,"P>|z|"] <= .1, "*", "")))

tab23 <- cbind(paste0(round(pe$mfxest[,"dF/dx"],4), stars), 
               paste0("(",round(pe$mfxest[,"Std. Err."],4), ")" ))

rownames(tab23) <- c("Wealth", "Age" ,"Age2", "Born in the village", "Education (in years)", "Parity", "Parity*Education (in years)")
colnames(tab23) = c( "Beta", "(se)")
kable(tab23)

```

```{r, include=FALSE}

if(saving){
fileConn<-file(paste0(output_folder, "/Table23_membership.tex"))
 writeLines(print.xtable(
     tab23 ,
    comment = FALSE,
    hline.after=c(0, 0, 7,7),
    table.placement = "h!",
    caption.placement = "top"), 
  fileConn)
close(fileConn)
}
```
## Composition of committees in Tuungane (Figure 3, Appendix F)

```{r, echo = TRUE}

par(mfrow = c(2,2))
with(IRC_tracking, {
  hist(femmes[pilot_lottery==1 & cdc_parity==0], main = "Nonparity villages, Research Data", breaks = ((0:10) - .5), labels = 0:10, xlim = c(0,10), ylim = c(0,350), xlab = "Number of women")
  hist(femmes[pilot_lottery==1 & cdc_parity==1], main = "Parity villages, Research Data", breaks = ((0:10) - .5), labels = 0:10, xlim = c(0,10), ylim = c(0,350), xlab = "Number of women")
  hist(femmes[pilot_lottery==1 & cdv_parity==0], main = "Nonparity villages, Project Data", breaks = ((0:10) - .5), labels = 0:10, xlim = c(0,10), ylim = c(0,350), xlab = "Number of women")
  hist(femmes[pilot_lottery==1 & cdv_parity==1], main = "Parity villages, Project Data", breaks = ((0:10) - .5), labels = 0:10, xlim = c(0,10), ylim = c(0,350), xlab = "Number of women")
  })

composition <-  recordPlot()

```

```{r, echo = FALSE}

if(saving){ 
pdf(file=paste0(output_folder, "/Fig3_composition.pdf"), width=10, height=8)
replayPlot(composition) 
#composition
invisible(dev.off())
}


```

This concludes the replication file.
